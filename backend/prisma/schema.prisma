generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Player {
  id                   String           @id @default(uuid())
  clerkId              String?          @unique
  firstName            String
  lastName             String
  email                String           @unique
  phone                String?
  streetAddress        String?
  city                 String?
  state                String?
  zipCode              String?
  dateOfBirth          DateTime?
  tosAcceptedAt        DateTime?
  privacyAcceptedAt    DateTime?
  waiverSignedAt       DateTime?
  profileCompletedAt   DateTime?        // Set when all required fields are filled
  membershipType       MembershipType   @default(NONE)
  membershipStatus     MembershipStatus @default(ACTIVE)
  statusUpdatedAt      DateTime         @default(now())
  classCredits         Int              @default(0)
  dropInCredits        Int              @default(0)
  stripeCustomerId     String?          @unique
  stripeSubscriptionId String?          @unique
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  enrollments          Enrollment[]
  transactions         Transaction[]
  // Competition relations
  captainedTeams       Team[]           @relation("TeamCaptain")
  teamRosters          TeamRoster[]
  freeAgentEntries     FreeAgent[]
  teamPayments         TeamPayment[]
}

model Staff {
  id        String    @id @default(uuid())
  clerkId   String?   @unique
  email     String    @unique
  firstName String
  lastName  String
  role      StaffRole @default(STAFF)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Event {
  id                String         @id @default(uuid())
  title             String
  description       String?
  eventType         EventType
  courtId           Int
  startTime         DateTime
  endTime           DateTime
  maxCapacity       Int            @default(12)
  currentEnrollment Int            @default(0)
  instructor        String?
  level       SkillLevel
  gender      GenderCategory
  isYouth     Boolean        @default(false)
  isRecurring Boolean        @default(false)
  status      EventStatus    @default(SCHEDULED)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  enrollments Enrollment[]
  match       Match?         // If this event is a competition match
}

model Enrollment {
  id        String           @id @default(uuid())
  playerId  String
  eventId   String
  status    EnrollmentStatus @default(REGISTERED)
  createdAt DateTime         @default(now())
  player    Player           @relation(fields: [playerId], references: [id])
  event     Event            @relation(fields: [eventId], references: [id])

  @@unique([playerId, eventId])
}

model Transaction {
  id              String            @id @default(uuid())
  playerId        String
  stripeProductId String
  productName     String?
  stripeSessionId String?           @unique
  amount          Decimal           @db.Decimal(10, 2)
  status          TransactionStatus @default(PENDING)
  createdAt       DateTime          @default(now())
  player          Player            @relation(fields: [playerId], references: [id])
}

enum StaffRole {
  ADMIN
  STAFF
}

enum MembershipType {
  GOLD
  DROP_IN
  NONE
}

enum MembershipStatus {
  ACTIVE
  PAUSED
  CANCELLED
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum EnrollmentStatus {
  REGISTERED
  WAITLISTED
  CANCELLED
  ATTENDED
  NO_SHOW
}

enum EventType {
  CLASS
  OPEN_PLAY
  PRIVATE_EVENT
  TOURNAMENT
  LEAGUE
  OTHER
}

enum SkillLevel {
  INTRO_I
  INTRO_II
  INTRO_III
  INTRO_IV
  INTERMEDIATE
  ADVANCED
}

enum GenderCategory {
  MENS
  WOMENS
  COED
}

enum EventStatus {
  SCHEDULED
  CANCELLED
  COMPLETED
}

// ============== COMPETITION ENUMS ==============

enum CompetitionType {
  LEAGUE          // Multi-week, recurring on same day
  TOURNAMENT      // Single day or weekend event
}

enum CompetitionFormat {
  INTERMEDIATE_4S
  RECREATIONAL_6S
}

enum CompetitionStatus {
  DRAFT           // Being configured by admin
  REGISTRATION    // Open for team sign-ups
  ACTIVE          // Season/tournament in progress
  COMPLETED       // Finished
}

enum TeamStatus {
  PENDING         // Not fully paid
  CONFIRMED       // Paid and roster complete
}

enum FreeAgentStatus {
  SEARCHING       // Looking for a team
  ASSIGNED        // Placed on a team by admin
}

enum TeamPaymentType {
  FULL            // Captain paid entire team fee
  SPLIT           // Player paid their portion
}

enum TeamPaymentStatus {
  PENDING
  COMPLETED
  REFUNDED
}

// ============== COMPETITION MODELS ==============

model Competition {
  id                   String            @id @default(uuid())
  name                 String            // e.g., "Spring 2025 Tuesday Intermediate 4s"
  type                 CompetitionType
  format               CompetitionFormat
  startDate            DateTime
  endDate              DateTime?
  pricePerTeam         Decimal           @db.Decimal(10, 2)
  maxTeams             Int               @default(8)
  status               CompetitionStatus @default(DRAFT)
  registrationDeadline DateTime?
  stripeProductId      String?           // Stripe product for team fee payments
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  teams      Team[]
  freeAgents FreeAgent[]
  matches    Match[]
}

model Team {
  id            String     @id @default(uuid())
  name          String
  competitionId String
  captainId     String
  status        TeamStatus @default(PENDING)
  paidInFull    Boolean    @default(false) // true = captain paid entire fee
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  competition Competition   @relation(fields: [competitionId], references: [id])
  captain     Player        @relation("TeamCaptain", fields: [captainId], references: [id])
  roster      TeamRoster[]
  homeMatches Match[]       @relation("HomeTeam")
  awayMatches Match[]       @relation("AwayTeam")
  payments    TeamPayment[]

  @@unique([competitionId, name])
}

model TeamRoster {
  id       String   @id @default(uuid())
  teamId   String
  playerId String
  joinedAt DateTime @default(now())

  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  player Player @relation(fields: [playerId], references: [id])

  @@unique([teamId, playerId])
}

model Match {
  id            String   @id @default(uuid())
  competitionId String
  eventId       String   @unique // Links to Event for calendar display
  homeTeamId    String
  awayTeamId    String
  roundNumber   Int      // Week number for leagues, round for tournaments
  isPlayoff     Boolean  @default(false)
  homeScore     Int?
  awayScore     Int?
  createdAt     DateTime @default(now())

  competition Competition @relation(fields: [competitionId], references: [id])
  event       Event       @relation(fields: [eventId], references: [id])
  homeTeam    Team        @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeam    Team        @relation("AwayTeam", fields: [awayTeamId], references: [id])

  @@index([competitionId, roundNumber])
}

model FreeAgent {
  id            String          @id @default(uuid())
  competitionId String
  playerId      String
  status        FreeAgentStatus @default(SEARCHING)
  notes         String?         // Player can leave notes about availability/preferences
  createdAt     DateTime        @default(now())

  competition Competition @relation(fields: [competitionId], references: [id])
  player      Player      @relation(fields: [playerId], references: [id])

  @@unique([competitionId, playerId])
}

model TeamPayment {
  id              String            @id @default(uuid())
  teamId          String
  playerId        String
  amount          Decimal           @db.Decimal(10, 2)
  paymentType     TeamPaymentType
  stripeSessionId String?           @unique
  status          TeamPaymentStatus @default(PENDING)
  paidAt          DateTime?
  createdAt       DateTime          @default(now())

  team   Team   @relation(fields: [teamId], references: [id])
  player Player @relation(fields: [playerId], references: [id])

  @@index([teamId])
}
