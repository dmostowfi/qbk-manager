generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Player {
  id                   String           @id @default(uuid())
  clerkId              String?          @unique
  firstName            String
  lastName             String
  email                String           @unique
  phone                String?
  streetAddress        String?
  city                 String?
  state                String?
  zipCode              String?
  dateOfBirth          DateTime?
  tosAcceptedAt        DateTime?
  privacyAcceptedAt    DateTime?
  waiverSignedAt       DateTime?
  profileCompletedAt   DateTime?        // Set when all required fields are filled
  membershipType       MembershipType   @default(NONE)
  membershipStatus     MembershipStatus @default(ACTIVE)
  statusUpdatedAt      DateTime         @default(now())
  classCredits         Int              @default(0)
  dropInCredits        Int              @default(0)
  stripeCustomerId     String?          @unique
  stripeSubscriptionId String?          @unique
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  enrollments          Enrollment[]
  transactions         Transaction[]
  // League relations
  captainedTeams       Team[]           @relation("TeamCaptain")
  teamRosters          TeamRoster[]
  freeAgentEntries     FreeAgent[]
  leaguePayments       LeaguePayment[]
}

model Staff {
  id        String    @id @default(uuid())
  clerkId   String?   @unique
  email     String    @unique
  firstName String
  lastName  String
  role      StaffRole @default(STAFF)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Event {
  id                String         @id @default(uuid())
  title             String
  description       String?
  eventType         EventType
  courtId           Int
  startTime         DateTime
  endTime           DateTime
  maxCapacity       Int            @default(12)
  currentEnrollment Int            @default(0)
  instructor        String?
  level       SkillLevel
  gender      GenderCategory
  isYouth     Boolean        @default(false)
  isRecurring Boolean        @default(false)
  status      EventStatus    @default(SCHEDULED)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  enrollments Enrollment[]
  leagueGame  LeagueGame?    // If this event is a league game
}

model Enrollment {
  id        String           @id @default(uuid())
  playerId  String
  eventId   String
  status    EnrollmentStatus @default(REGISTERED)
  createdAt DateTime         @default(now())
  player    Player           @relation(fields: [playerId], references: [id])
  event     Event            @relation(fields: [eventId], references: [id])

  @@unique([playerId, eventId])
}

model Transaction {
  id              String            @id @default(uuid())
  playerId        String
  stripeProductId String
  productName     String?
  stripeSessionId String?           @unique
  amount          Decimal           @db.Decimal(10, 2)
  status          TransactionStatus @default(PENDING)
  createdAt       DateTime          @default(now())
  player          Player            @relation(fields: [playerId], references: [id])
}

enum StaffRole {
  ADMIN
  STAFF
}

enum MembershipType {
  GOLD
  DROP_IN
  NONE
}

enum MembershipStatus {
  ACTIVE
  PAUSED
  CANCELLED
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum EnrollmentStatus {
  REGISTERED
  WAITLISTED
  CANCELLED
  ATTENDED
  NO_SHOW
}

enum EventType {
  CLASS
  OPEN_PLAY
  PRIVATE_EVENT
  TOURNAMENT
  LEAGUE
  OTHER
}

enum SkillLevel {
  INTRO_I
  INTRO_II
  INTRO_III
  INTRO_IV
  INTERMEDIATE
  ADVANCED
}

enum GenderCategory {
  MENS
  WOMENS
  COED
}

enum EventStatus {
  SCHEDULED
  CANCELLED
  COMPLETED
}

// ============== LEAGUE ENUMS ==============

enum LeagueFormat {
  INTERMEDIATE_4S
  RECREATIONAL_6S
}

enum LeagueStatus {
  DRAFT           // Being configured by admin
  REGISTRATION    // Open for team sign-ups
  ACTIVE          // Season in progress
  COMPLETED       // Season finished
}

enum TeamStatus {
  PENDING         // Not fully paid
  CONFIRMED       // Paid and roster complete
}

enum FreeAgentStatus {
  SEARCHING       // Looking for a team
  ASSIGNED        // Placed on a team by admin
}

enum LeaguePaymentType {
  FULL            // Captain paid entire team fee
  SPLIT           // Player paid their portion
}

enum LeaguePaymentStatus {
  PENDING
  COMPLETED
  REFUNDED
}

// ============== LEAGUE MODELS ==============

model League {
  id                   String       @id @default(uuid())
  name                 String       // e.g., "Spring 2025 Tuesday Intermediate 4s"
  format               LeagueFormat
  dayOfWeek            Int          // 0=Sunday, 1=Monday, ..., 6=Saturday
  seasonStartDate      DateTime
  numberOfWeeks        Int          @default(8)
  pricePerTeam         Decimal      @db.Decimal(10, 2)
  maxTeams             Int          @default(8)
  status               LeagueStatus @default(DRAFT)
  registrationDeadline DateTime?
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  teams      Team[]
  freeAgents FreeAgent[]
  games      LeagueGame[]
}

model Team {
  id         String     @id @default(uuid())
  name       String
  leagueId   String
  captainId  String
  status     TeamStatus @default(PENDING)
  paidInFull Boolean    @default(false) // true = captain paid entire fee
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  league    League          @relation(fields: [leagueId], references: [id])
  captain   Player          @relation("TeamCaptain", fields: [captainId], references: [id])
  roster    TeamRoster[]
  homeGames LeagueGame[]    @relation("HomeTeam")
  awayGames LeagueGame[]    @relation("AwayTeam")
  payments  LeaguePayment[]

  @@unique([leagueId, name])
}

model TeamRoster {
  id       String   @id @default(uuid())
  teamId   String
  playerId String
  joinedAt DateTime @default(now())

  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  player Player @relation(fields: [playerId], references: [id])

  @@unique([teamId, playerId])
}

model LeagueGame {
  id         String   @id @default(uuid())
  leagueId   String
  eventId    String   @unique // Links to Event for calendar display
  homeTeamId String
  awayTeamId String
  weekNumber Int
  timeSlot   Int      // 0=6pm, 1=7pm, 2=8pm, 3=9pm
  homeScore  Int?
  awayScore  Int?
  createdAt  DateTime @default(now())

  league   League @relation(fields: [leagueId], references: [id])
  event    Event  @relation(fields: [eventId], references: [id])
  homeTeam Team   @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeam Team   @relation("AwayTeam", fields: [awayTeamId], references: [id])

  @@index([leagueId, weekNumber])
}

model FreeAgent {
  id        String          @id @default(uuid())
  leagueId  String
  playerId  String
  status    FreeAgentStatus @default(SEARCHING)
  notes     String?         // Player can leave notes about availability/preferences
  createdAt DateTime        @default(now())

  league League @relation(fields: [leagueId], references: [id])
  player Player @relation(fields: [playerId], references: [id])

  @@unique([leagueId, playerId])
}

model LeaguePayment {
  id              String              @id @default(uuid())
  teamId          String
  playerId        String
  amount          Decimal             @db.Decimal(10, 2)
  paymentType     LeaguePaymentType
  stripeSessionId String?             @unique
  status          LeaguePaymentStatus @default(PENDING)
  paidAt          DateTime?
  createdAt       DateTime            @default(now())

  team   Team   @relation(fields: [teamId], references: [id])
  player Player @relation(fields: [playerId], references: [id])

  @@index([teamId])
}
